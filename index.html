<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ค้นหาพนักงาน</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #result-card {
      transition: background-color 0.3s ease;
    }
    #chair_id_display {
      font-size: 2rem;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">ค้นหาพนักงานด้วยรหัสพนักงาน</h2>

    <div class="input-group mb-4">
      <input type="text" id="empIdInput" class="form-control" placeholder="กรอกรหัสพนักงาน">
      <button class="btn btn-primary" onclick="searchEmployee()">ค้นหา</button>
    </div>

    <div id="result" class="d-none">
      <div id="result-card" class="card text-dark">
        <div class="card-body">
          <h5 class="card-title" id="emp_fullname"></h5>
          <p class="card-text">
            <strong>ตำแหน่ง:</strong> <span id="emp_position"></span><br>
            <strong>หน่วยงาน:</strong> <span id="emp_office"></span><br>
          </p>
          <button id="registerBtn" class="btn btn-success" onclick="register()">ลงทะเบียน</button>
          <div id="extra-info" class="mt-4 d-none">
            <div><strong>เลขที่นั่ง:</strong> <div id="chair_id_display" class="mb-2"></div></div>
          </div>
        </div>
      </div>
    </div>

    <div id="not-found" class="alert alert-danger d-none mt-3">ไม่พบข้อมูล</div>
  </div>

  <script>
    const supabaseUrl = 'https://ptnzksgezohnnlmtlxod.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0bnprc2dlem9obm5sbXRseG9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2OTA3ODMsImV4cCI6MjA2MjI2Njc4M30.SID4SIitrQrK6iBQAzw7BKmRnFmv8nEu2Z8YRrqxIG0'; // ← ใส่เต็มเหมือนเดิม
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let currentEmp = null;

    async function searchEmployee() {
      const empId = document.getElementById('empIdInput').value.trim();
      const resultCard = document.getElementById('result-card');
      const notFound = document.getElementById('not-found');
      const result = document.getElementById('result');
      const extraInfo = document.getElementById('extra-info');
      const registerBtn = document.getElementById('registerBtn');

      if (!empId) return;

      result.classList.add('d-none');
      notFound.classList.add('d-none');
      extraInfo.classList.add('d-none');
      resultCard.style.backgroundColor = '';

      const { data, error } = await supabaseClient
        .from('ceoconnect_regis')
        .select('emp_fullname, emp_position, emp_office, chair_id, color, regis_status')
        .eq('emp_id', empId)
        .single();

      if (error || !data) {
        notFound.classList.remove('d-none');
        return;
      }

      currentEmp = { ...data, emp_id: empId }; // เก็บไว้ใช้ตอนลงทะเบียน

      document.getElementById('emp_fullname').textContent = data.emp_fullname;
      document.getElementById('emp_position').textContent = data.emp_position;
      document.getElementById('emp_office').textContent = data.emp_office;

      if (data.regis_status === '1') {
        showFullInfo();
      } else {
        registerBtn.classList.remove('d-none');
        result.classList.remove('d-none');
      }
    }

    async function register() {
      if (!currentEmp) return;

      const { error } = await supabaseClient
        .from('ceoconnect_regis')
        .update({ regis_status: '1' })
        .eq('emp_id', currentEmp.emp_id);

      if (error) {
        alert('ลงทะเบียนไม่สำเร็จ');
        return;
      }

      currentEmp.regis_status = '1';
      showFullInfo();
    }

    function showFullInfo() {
      const resultCard = document.getElementById('result-card');
      const result = document.getElementById('result');
      const extraInfo = document.getElementById('extra-info');
      const registerBtn = document.getElementById('registerBtn');

      document.getElementById('chair_id_display').textContent = currentEmp.chair_id || '-';
      resultCard.style.backgroundColor = '#' + (currentEmp.color || '6c757d');

      registerBtn.classList.add('d-none');
      extraInfo.classList.remove('d-none');
      result.classList.remove('d-none');
    }
  </script>
</body>
</html>
